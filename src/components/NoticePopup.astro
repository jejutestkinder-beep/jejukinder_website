---
interface Props {
  notice: {
    slug: string;
    data: {
      title: string;
    };
  };
  Content: any;
  index?: number;
}

const { notice, Content, index = 0 } = Astro.props;
---

<div id={`popup-overlay-${notice.slug}`} class="popup-overlay" style={`display: none; z-index: ${9999 + index};`}>
  <div class="popup-modal" role="dialog" aria-modal="true" aria-label="공지 팝업">
    <div class="popup-header">
      <strong class="popup-title">{notice.data.title}</strong>
      <button id={`popup-close-${notice.slug}`} class="popup-close" type="button" aria-label="닫기">✕</button>
    </div>

    <div class="popup-body">
      <Content />
    </div>

    <div class="popup-actions">
      <button id={`popup-hide-today-${notice.slug}`} class="popup-btn" type="button">오늘 하루 보지 않기</button>
      <button id={`popup-close-2-${notice.slug}`} class="popup-btn primary" type="button">닫기</button>
    </div>
  </div>
</div>

<script is:inline define:vars={{ slug: notice.slug, index: Astro.props.index || 0 }}>
  (function() {
    const initPopup = () => {
      const overlay = document.getElementById(`popup-overlay-${slug}`);
      const modal = overlay?.querySelector('.popup-modal');

      if (!overlay || !modal) return;

      const todayKey = new Date().toISOString().slice(0, 10);
      const storageKey = `kinder_popup_hide_${slug}`;

      const hide = () => {
        overlay.style.display = "none";
        checkAllPopupsClosed();
      };

      const show = () => {
        overlay.removeAttribute("hidden");
        overlay.style.display = "flex";
        
        // 팝업 위치 및 배경색 조정
        setTimeout(() => {
          const allPopups = Array.from(document.querySelectorAll('.popup-overlay')).filter(p => p.style.display === 'flex');
          const currentIndex = allPopups.indexOf(overlay);
          const totalPopups = allPopups.length;
          
          if (currentIndex !== -1) {
            // 1. 배경색 처리: 첫 번째(가장 아래) 팝업만 어두운 배경을 가짐
            if (currentIndex > 0) {
              overlay.style.background = "transparent";
              overlay.style.pointerEvents = "none"; // 뒤의 팝업 클릭 가능하게
              modal.style.pointerEvents = "auto";   // 모달 자체는 클릭 가능하게
            }

            // 2. 위치 처리
            const isDesktop = window.innerWidth > 768;
            if (isDesktop && totalPopups > 1) {
              // 데스크탑: 좌우 배치
              const offsetSide = (currentIndex - (totalPopups - 1) / 2) * 45; // 45%씩 좌우 이동
              modal.style.transform = `translateX(${offsetSide}%)`;
            } else if (totalPopups > 1) {
              // 모바일: 현재처럼 약간 어긋나게 겹침
              const offsetX = (currentIndex - (totalPopups - 1) / 2) * 20;
              const offsetY = (currentIndex - (totalPopups - 1) / 2) * 20;
              modal.style.transform = `translate(${offsetX}px, ${offsetY}px)`;
            }
            
            overlay.style.zIndex = (9999 + currentIndex).toString();
          }
        }, 50);
        
        document.body.style.overflow = "hidden";
      };

      const checkAllPopupsClosed = () => {
        const allPopups = Array.from(document.querySelectorAll('[id^="popup-overlay-"]'));
        const visiblePopups = allPopups.filter(p => p.style.display === 'flex');
        
        if (visiblePopups.length === 0) {
          document.body.style.overflow = "";
        }
      };

      const stored = localStorage.getItem(storageKey);
      if (stored === todayKey) {
        hide();
        return;
      }

      show();

      const closeBtn1 = document.getElementById(`popup-close-${slug}`);
      const closeBtn2 = document.getElementById(`popup-close-2-${slug}`);
      const hideTodayBtn = document.getElementById(`popup-hide-today-${slug}`);

      if (closeBtn1) closeBtn1.onclick = hide;
      if (closeBtn2) closeBtn2.onclick = hide;
      if (hideTodayBtn) {
        hideTodayBtn.onclick = () => {
          localStorage.setItem(storageKey, todayKey);
          hide();
        };
      }

      overlay.onclick = (e) => {
        if (e.target === overlay) hide();
      };

      const handleEsc = (e) => {
        if (e.key === "Escape" && overlay.style.display === "flex") hide();
      };
      document.addEventListener("keydown", handleEsc);
    };

    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", initPopup);
    } else {
      initPopup();
    }
  })();
</script>

<style>
  .popup-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.45);
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 20px;
    pointer-events: auto;
  }
  .popup-modal {
    width: min(450px, 90%); /* 팝업 너비를 약간 줄여서 좌우 배치가 잘 보이게 함 */
    max-width: 90vw;
    background: white;
    border-radius: 16px;
    overflow: hidden;
    box-shadow: 0 20px 60px rgba(0,0,0,0.25);
    position: relative;
    margin: 20px;
    transition: transform 0.2s ease;
  }
  .popup-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 12px;
    padding: 16px 18px;
    border-bottom: 1px solid #eee;
  }
  .popup-title {
    font-size: 16px;
  }
  .popup-close {
    border: 0;
    background: transparent;
    font-size: 18px;
    cursor: pointer;
    padding: 6px 8px;
    line-height: 1;
  }
  .popup-body {
    padding: 16px 18px;
    max-height: 55vh;
    overflow: auto;
  }
  .popup-actions {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
    padding: 14px 18px;
    border-top: 1px solid #eee;
  }
  .popup-btn {
    border: 1px solid #ddd;
    background: #fff;
    padding: 10px 12px;
    border-radius: 10px;
    cursor: pointer;
    font-size: 14px;
  }
  .popup-btn.primary {
    border-color: #222;
    background: #222;
    color: white;
  }
</style>
