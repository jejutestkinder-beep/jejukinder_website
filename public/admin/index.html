<!doctype html>
<html>
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
		<title>Admin</title>
	</head>
	<body>
		<div id="nc-root"></div>

		<script src="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js"></script>

		<script>
			(function () {
				// GitHub OAuth code가 URL에 있으면 서버 사이드로 리다이렉트 (보안: 즉시 리다이렉트)
				const urlParams = new URLSearchParams(window.location.search);
				const code = urlParams.get('code');
				if (code && /^[a-zA-Z0-9_-]+$/.test(code) && code.length <= 200) {
					// 서버 사이드로 즉시 리다이렉트 (클라이언트에서 code 처리하지 않음)
					window.location.replace(`/.netlify/functions/auth?code=${encodeURIComponent(code)}`);
					return;
				}

				// Netlify Identity 위젯이 로드될 때까지 대기
				function waitForIdentity() {
					if (!window.netlifyIdentity) {
						setTimeout(waitForIdentity, 50);
						return;
					}

					const hash = window.location.hash || "";
					const hasToken =
						hash.includes("invite_token=") ||
						hash.includes("recovery_token=") ||
						hash.includes("confirmation_token=");

					if (!hasToken) return;

					// 토큰 처리
					function handleToken() {
						if (hash.includes("invite_token=") || hash.includes("recovery_token=")) {
							window.netlifyIdentity.open("signup");
						} else {
							window.netlifyIdentity.open();
						}
					}

					window.netlifyIdentity.on("init", handleToken);
					window.netlifyIdentity.init();

					// init이 이미 완료되었을 수 있으므로 한 번 더 확인
					setTimeout(handleToken, 100);
				}

				waitForIdentity();
			})();
		</script>
	</body>
</html>
