<!doctype html>
<html>
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
		<title>Admin</title>
    <style>
      /* Netlify Identity 위젯 내의 이메일/비밀번호 입력 폼을 숨깁니다 */
      #netlify-identity-widget .netlify-identity-menu,
      #netlify-identity-widget .netlify-identity-form {
        display: none !important;
      }
      /* 대신 소셜 로그인(GitHub) 버튼 영역만 보이게 합니다 */
      #netlify-identity-widget .netlify-identity-providers {
        display: block !important;
        border: none !important;
      }
    </style>
	</head>
	<body>
		<div id="nc-root"></div>

		<script src="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js"></script>

		<script>
			(function () {
				// GitHub OAuth code가 URL에 있으면 서버 사이드로 리다이렉트 (보안: 즉시 리다이렉트)
				const urlParams = new URLSearchParams(window.location.search);
				const code = urlParams.get('code');
				if (code && /^[a-zA-Z0-9_-]+$/.test(code) && code.length <= 200) {
					// 서버 사이드로 즉시 리다이렉트 (클라이언트에서 code 처리하지 않음)
					window.location.replace(`/.netlify/functions/auth?code=${encodeURIComponent(code)}`);
					return;
				}

				// Netlify Identity 위젯이 로드될 때까지 대기
				function waitForIdentity() {
					if (!window.netlifyIdentity) {
						setTimeout(waitForIdentity, 50);
						return;
					}

					const hash = window.location.hash || "";
					const hasToken =
						hash.includes("invite_token=") ||
						hash.includes("recovery_token=") ||
						hash.includes("confirmation_token=");

					if (!hasToken) return;

					// 토큰 처리
					function handleToken() {
						if (hash.includes("invite_token=") || hash.includes("recovery_token=")) {
							window.netlifyIdentity.open("signup");
						} else {
							window.netlifyIdentity.open();
						}
					}

					window.netlifyIdentity.on("init", handleToken);
					window.netlifyIdentity.init();

					// init이 이미 완료되었을 수 있으므로 한 번 더 확인
					setTimeout(handleToken, 100);
				}

				waitForIdentity();
			})();

			// 팝업 개수 제한 (최대 2개) - 경고만 표시
			(function() {
				const MAX_POPUPS = 2;
				
				function initPopupLimit() {
					// CMS가 완전히 로드될 때까지 대기
					if (typeof window.CMS === 'undefined') {
						setTimeout(initPopupLimit, 200);
						return;
					}

					// 팝업 필드 변경 시 경고만 표시
					setTimeout(function() {
						const observer = new MutationObserver(function(mutations) {
							const popupField = document.querySelector('input[name="popup"][type="checkbox"]');
							if (popupField && !popupField.dataset.listenerAdded) {
								popupField.dataset.listenerAdded = 'true';
								popupField.addEventListener('change', function(e) {
									if (e.target.checked) {
										// 경고 메시지만 표시 (실제 제한은 서버 사이드에서 처리)
										const confirmed = confirm('팝업은 최대 2개까지만 설정할 수 있습니다. 계속하시겠습니까?');
										if (!confirmed) {
											e.target.checked = false;
										}
									}
								});
							}
						});

						observer.observe(document.body, {
							childList: true,
							subtree: true
						});
					}, 2000);
				}

				initPopupLimit();
			})();
		</script>
	</body>
</html>
