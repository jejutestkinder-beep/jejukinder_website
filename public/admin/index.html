<!doctype html>
<html>
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
		<title>Admin</title>
	</head>
	<body>
		<div id="nc-root"></div>

		<script src="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js"></script>

		<script>
			(function () {
				// GitHub OAuth code가 URL에 있으면 서버 사이드로 리다이렉트 (보안: 즉시 리다이렉트)
				const urlParams = new URLSearchParams(window.location.search);
				const code = urlParams.get('code');
				if (code && /^[a-zA-Z0-9_-]+$/.test(code) && code.length <= 200) {
					// 서버 사이드로 즉시 리다이렉트 (클라이언트에서 code 처리하지 않음)
					window.location.replace(`/.netlify/functions/auth?code=${encodeURIComponent(code)}`);
					return;
				}

				// Netlify Identity 위젯이 로드될 때까지 대기
				function waitForIdentity() {
					if (!window.netlifyIdentity) {
						setTimeout(waitForIdentity, 50);
						return;
					}

					const hash = window.location.hash || "";
					const hasToken =
						hash.includes("invite_token=") ||
						hash.includes("recovery_token=") ||
						hash.includes("confirmation_token=");

					if (!hasToken) return;

					// 토큰 처리
					function handleToken() {
						if (hash.includes("invite_token=") || hash.includes("recovery_token=")) {
							window.netlifyIdentity.open("signup");
						} else {
							window.netlifyIdentity.open();
						}
					}

					window.netlifyIdentity.on("init", handleToken);
					window.netlifyIdentity.init();

					// init이 이미 완료되었을 수 있으므로 한 번 더 확인
					setTimeout(handleToken, 100);
				}

				waitForIdentity();
			})();

			// 팝업 개수 제한 (최대 3개)
			(function() {
				const MAX_POPUPS = 3;
				
				function initPopupLimit() {
					// CMS가 완전히 로드될 때까지 대기
					if (typeof window.CMS === 'undefined' || !window.CMS.registerEventListener) {
						setTimeout(initPopupLimit, 200);
						return;
					}

					// preSave 이벤트 리스너 등록
					window.CMS.registerEventListener({
						name: 'preSave',
						handler: ({ entry, collection }) => {
							if (collection === 'notices' && entry.data.popup === true) {
								// 현재 편집 중인 항목을 제외한 다른 공지사항들 확인
								const allEntries = window.CMS.getEntries('notices') || [];
								const activePopups = allEntries.filter(n => {
									// 현재 편집 중인 항목 제외
									if (n.slug === entry.slug) return false;
									const data = n.data || {};
									return data.popup === true;
								});
								
								if (activePopups.length >= MAX_POPUPS) {
									alert('최대 팝업 수(3개)를 초과했습니다. 팝업을 원하시면 기존 팝업을 취소해주세요.');
									return false; // 저장 취소
								}
							}
							return true; // 저장 허용
						}
					});

					// 팝업 필드 변경 시 실시간 체크
					setTimeout(function() {
						const observer = new MutationObserver(function(mutations) {
							const popupField = document.querySelector('input[name="popup"][type="checkbox"]');
							if (popupField && !popupField.dataset.listenerAdded) {
								popupField.dataset.listenerAdded = 'true';
								popupField.addEventListener('change', function(e) {
									if (e.target.checked) {
										try {
											const allEntries = window.CMS.getEntries('notices') || [];
											const activePopups = allEntries.filter(n => {
												const data = n.data || {};
												return data.popup === true;
											});
											
											if (activePopups.length >= MAX_POPUPS) {
												e.target.checked = false;
												alert('최대 팝업 수(3개)를 초과했습니다. 팝업을 원하시면 기존 팝업을 취소해주세요.');
											}
										} catch (error) {
											console.error('팝업 개수 확인 중 오류:', error);
										}
									}
								});
							}
						});

						observer.observe(document.body, {
							childList: true,
							subtree: true
						});
					}, 2000);
				}

				initPopupLimit();
			})();
		</script>
	</body>
</html>
